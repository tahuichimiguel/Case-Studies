---
title: "Glass"
author: "Mikhail Lara"
date: "February 2, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries & Data

```{r cars}
options(warn = -1)
library(data.table)
library(ggplot2)
library(e1071)
library(MASS)
library(caret)
library(gbm)

path <-'/Users/Mikey/Documents/ML-Case-Studies/Glass'
filename<-'glass.csv'
setwd(path)
DT<-fread(filename)
```

#EDA & Cleaning
```{r}
DT[,Type:=as.factor(Type)]

summary(DT)
print('# of Each Class')
DT[,.N,by=Type]

#Processing: OMIT ANY Type 6 Glass (Minor Cross-Over with Groups 1[1],2[3],3[1])
DT.omit6 <- DT[!((K==0)&(Fe==0)&(Ba==0))]
DT.omit6[,.N,by=Type]

#Remove Barium Outliers
#(Ba>2)
#(Type=='1')&(Ba>0.5)

#Remove K Outliers
type5.avg.K<-mean(DT.omit6[Type=='5']$K)
type5.sd.K<-sd(DT.omit6[Type=='5']$K)
thresh.type5.sd.K<-type5.avg.K+2*sd(DT.omit6[Type=='5']$K)
#(K>thresh.type5.sd.K)&(Type==5)

DT.clean<-DT.omit6[!((Ba>2)|(Type=='1')&(Ba>0.5)|(K>thresh.type5.sd.K)&(Type==5) )]
DT.clean[,.N,by=Type]
```

```{r}
ggplot(data=DT.clean,aes(y=RI,x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1)

ggplot(data=DT.clean,aes(y=Na,x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1) # Group 7 has higher Na than other groups & is Normal (p=0.001)

ggplot(data=DT.clean,aes(y=Mg,x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1) # Groups 1,2,3 have much higher Mg than 5&7

ggplot(data=DT.clean,aes(y=Al,x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1) # Groups 5 & 7 have higher and distinct Al levels than other groups
ggplot(data=DT.clean,aes(y=Si,x=as.factor(Type)))+geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1)

ggplot(data=DT.clean,aes(y=K, x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1) # Groups 7 skew higher for K than other groups

ggplot(data=DT.clean,aes(y=Ca,x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1)  

ggplot(data=DT.clean,aes(y=Ba,x=as.factor(Type)))+
    geom_violin(draw_quantiles=c(0.25,0.75))+geom_jitter(width=.1) # For Group 5 & 7, 7 is somewhat normal (p=0.001) 

ggplot(data=DT.clean,aes(y=Fe,x=as.factor(Type)))+
  geom_violin(draw_quantiles=c(0.25,0.75))+ geom_jitter(width=.1) # Group 7 has lower Fe than other groups 

```

##LDA
```{r pressure, echo=FALSE}
lda.fit<-lda(Type~.,data = DT.clean)
lda.fit
lda.fit$svd

DT.lda<-as.matrix(DT.clean[,-c('Type'),with=FALSE])
DT.lda<- DT.lda %*% lda.fit$scaling
DF.lda<-data.frame(DT.lda,DT.clean$Type)
names(DF.lda)<-c( "LD1"     ,      "LD2"     ,      "LD3"     ,      "LD4"         ,  "Type")

ggplot(data=DF.lda, aes(x=LD1,y=LD2,colour=as.factor(Type)))+geom_point()

ggplot(data=DF.lda, aes(x=LD1,fill=as.factor(Type)))+geom_density(alpha=0.25) # Type 5 & 7
ggplot(data=DF.lda, aes(x=LD2,fill=as.factor(Type)))+geom_density(alpha=0.25) # Type 5
ggplot(data=DF.lda, aes(x=LD3,fill=as.factor(Type)))+geom_density(alpha=0.25) 
ggplot(data=DF.lda, aes(x=LD4,fill=as.factor(Type)))+geom_density(alpha=0.25) # Type 3?

ggplot(data=DF.lda, aes(x=LD1+LD2,y=LD3,colour=as.factor(Type)))+geom_point()
ggplot(data=DF.lda, aes(x=LD1+LD2,fill=as.factor(Type)))+geom_density(alpha=0.25) # Type 7 
```

##PCA
```{r pressure, echo=FALSE}
PCA<-prcomp(x=DT.clean[,-c('Type'),with=FALSE])

DT.pca<-as.matrix(DT.clean[,-c('Type'),with=FALSE])
DT.pca<- DT.pca %*% PCA$rotation
DF.pca<-data.frame(DT.pca,DT.clean$Type)

ggplot(data=DF.pca, aes(x=PC1,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25) 
ggplot(data=DF.pca, aes(x=PC2,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25)
ggplot(data=DF.pca, aes(x=PC3,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25) 
ggplot(data=DF.pca, aes(x=PC4,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25)
ggplot(data=DF.pca, aes(x=PC5,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25)
ggplot(data=DF.pca, aes(x=PC6,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25)
ggplot(data=DF.pca, aes(x=PC7,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25) 
ggplot(data=DF.pca, aes(x=PC8,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25)
ggplot(data=DF.pca, aes(x=PC9,fill=as.factor(DF.pca[,10])))+geom_density(alpha=0.25) 

```

F1:Type 7 Feature: PC2 Separates Type 7 from rest {DONE}
F2:Type 7 Feature: Ba 25% Quantile ~ 0.5, is higher that all other class maxima [Higher Ba ~ Higher P(Type 7)] <Use Simulations to Determine Threshold>
F3:Type 5 Feature: PC3 Mildly Separates Type 5 from rest {DONE}
F4:Type 5 Feature: LD2 clearly separates Type 5. {DONE}
F5:Type 3 Feature: PC9 Mildly Separates Type 3 from rest {DONE}

F6:Type 6 Feature: Has Zero Potassium, Barium, or Iron (Unique Characteristic for that type of glass). 

F7:Type 5 & 7 Feature: PC1 Separates 5 & 7 from rest {DONE}
F8:Type 5 & 7 Feature :LD1 may be able to be used to identity groups 5 & 7. Making the distributions more peaked (kurtosis) may help. {DONE}
F9:Type 5 & 7 Feature: Mean Mg of Combined Groups are Less than Mean Mg of Combined Groups 1,2,3  <Use Simulations to Determine Threshold>

##Feature Engineering for (1-2), 3, 5, & 7
```{r}
DT.feat<-data.table(DT.clean)

pca.2<-PCA$rotation[,2]
  DT.feat[,F1:=RI*pca.2[1] +Na*pca.2[2] +Mg*pca.2[3] +Al*pca.2[4] +Si*pca.2[5] +K*pca.2[6] +Ca*pca.2[7] +Ba*pca.2[8] +Fe*pca.2[9]]

sims<-matrix(nrow=10000,ncol=50)
    quant<-vector(mode='numeric',length=10000)
    samps.sin7<- DT.clean[(Type!='7')]$Ba
    for(i in 1:10000){
        sims[i,]<-sample(x=samps.sin7, size=50,replace=TRUE)
        quant[i]<-quantile(sims[i,],probs=0.95)
    }
    Ba.Thresh<-mean(quant)
    Ba.type7.mean<-mean(DT.feat[Type=='7']$Ba)
    DT.feat[,F2:=ifelse(Ba>Ba.Thresh,exp(3.25/(abs(Ba-Ba.type7.mean)^1.7+Ba.type7.mean)),Ba)]
  
pca.3<-PCA$rotation[,3]
  DT.feat[,F3:=RI*pca.3[1] +Na*pca.3[2] +Mg*pca.3[3] +Al*pca.3[4] +Si*pca.3[5] +K*pca.3[6] +Ca*pca.3[7] +Ba*pca.3[8] +Fe*pca.3[9]]

ld.2<-lda.fit$scaling[,2]
  DT.feat[,F4:=RI*ld.2[1] +Na*ld.2[2] +Mg*ld.2[3] +Al*ld.2[4] +Si*ld.2[5] +K*ld.2[6] +Ca*ld.2[7] +Ba*ld.2[8] +Fe*ld.2[9]]
  
pca.9<-PCA$rotation[,9]
  DT.feat[,F5:=RI*pca.9[1] +Na*pca.9[2] +Mg*pca.9[3] +Al*pca.9[4] +Si*pca.9[5] +K*pca.9[6] +Ca*pca.9[7] +Ba*pca.9[8] +Fe*pca.9[9]]
  
pca.1<-PCA$rotation[,1]
  DT.feat[,F7:=RI*pca.1[1] +Na*pca.1[2] +Mg*pca.1[3] +Al*pca.1[4] +Si*pca.1[5] +K*pca.1[6] +Ca*pca.1[7] +Ba*pca.1[8] +Fe*pca.1[9]]
  
ld.1<-lda.fit$scaling[,1]
  DT.feat[,F8:=RI*ld.1[1] +Na*ld.1[2] +Mg*ld.1[3] +Al*ld.1[4] +Si*ld.1[5] +K*ld.1[6] +Ca*ld.1[7] +Ba*ld.1[8] +Fe*ld.1[9]]
  
sims<-matrix(nrow=10000,ncol=50)
    quant<-vector(mode='numeric',length=10000)
    samps<- DT.clean[(Type!='7')&(Type!='5')]$Mg
    for(i in 1:10000){
        sims[i,]<-sample(samps, size=50,replace=TRUE)
        quant[i]<-quantile(sims[i,],probs=0.25)
    }
    F9_Thresh<-mean(quant)
    DT.feat[,F9:=ifelse(Mg>=F9_Thresh,(Mg-F9_Thresh)^2,0)]

DT.feat[,group:=ifelse(Type=='7','7',ifelse(Type=='5','5','123'))]
      
DT.feat[,RI:=NULL]
DT.feat[,Na:=NULL]
DT.feat[,Mg:=NULL]
DT.feat[,Al:=NULL]
DT.feat[,Si:=NULL]
DT.feat[,K:=NULL]
DT.feat[,Ca:=NULL]
DT.feat[,Ba:=NULL]
DT.feat[,Fe:=NULL]

ggplot(DT.feat,aes(x=F1,fill=Type))+geom_density(alpha=0.2)
ggplot(DT.feat,aes(x=F2,fill=Type))+geom_density(alpha=0.2)
ggplot(DT.feat,aes(x=F3,fill=Type))+geom_density(alpha=0.2)
ggplot(DT.feat,aes(x=F4,fill=Type))+geom_density(alpha=0.2)
ggplot(DT.feat,aes(x=F5,fill=Type))+geom_density(alpha=0.2)
ggplot(DT.feat,aes(x=F7,fill=Type))+geom_density(alpha=0.2)
ggplot(DT.feat,aes(x=F8,fill=Type))+geom_density(alpha=0.2)


```

##LDA w/ Engineered Features
```{r}
lda.feat<-lda(group~.,data = DT.feat[,-c('Type'),with=FALSE])
lda.feat
lda.feat$svd

mat.lda.feat<-as.matrix(DT.feat[,-c('group','Type'),with=FALSE])
mat.lda.feat<- mat.lda.feat %*% lda.feat$scaling
DF.lda.feat<-data.frame(mat.lda.feat,DT.feat$group)
names(DF.lda.feat)<-c('LD1','LD2','group')

ggplot(data=DF.lda.feat, aes(x=LD1,fill=as.factor(group)))+geom_density(alpha=0.25) 
ggplot(data=DF.lda.feat, aes(x=LD2,fill=as.factor(group)))+geom_density(alpha=0.25) 

ggplot(data=DF.lda.feat, aes(x=LD1,y=LD2,colour=as.factor(group)))+geom_point()
```
Can clearly distinguish between Types (123), 5, and 7


##PCA w/ Engineered Features
```{r}
PCA.feat<-prcomp(x=DT.feat[,-c('group','Type'),with=FALSE])

mat.pca.feat<-as.matrix(DT.feat[,-c('group','Type'),with=FALSE])
mat.pca.feat<- mat.pca.feat %*% PCA.feat$rotation
DF.pca.feat<-data.frame(mat.pca.feat,DT.feat$group)

summary(PCA.feat)

ggplot(data=DF.pca.feat, aes(x=PC1,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
ggplot(data=DF.pca.feat, aes(x=PC2,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
ggplot(data=DF.pca.feat, aes(x=PC3,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25)
ggplot(data=DF.pca.feat, aes(x=PC4,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
ggplot(data=DF.pca.feat, aes(x=PC5,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
ggplot(data=DF.pca.feat, aes(x=PC6,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
ggplot(data=DF.pca.feat, aes(x=PC7,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
ggplot(data=DF.pca.feat, aes(x=PC8,fill=as.factor(DT.feat.group)))+geom_density(alpha=0.25) 
 
ggplot(data=DF.pca.feat, aes(x=PC1,y=PC2,colour=as.factor(DT.feat.group)))+geom_point()

```
Can distinguish between Types (123),5,and 7 well with 1st 2 PC


##Gradient Boosting for Types (123),5,and 7
```{r}
DT.gbm<-data.table(DF.lda.feat,DF.pca.feat$PC1,DF.pca.feat$PC2)
setnames(DT.gbm,old=names(DT.gbm),new=c('LD1','LD2','group','PC1','PC2'))

# define training control
train_controlA<- trainControl(method="LOOCV")
train_controlB<- trainControl(method="cv", number=(5))

# train the model 
set.seed(123)
gbm.fit<- train(group~., data=DT.gbm, trControl=train_controlB, method="gbm")

gbm.fit
plot(gbm.fit)
summary(gbm.fit)
confusionMatrix(predict(gbm.fit,DT.gbm),DT.gbm$group)

```
Can accurately distinguish between Type (123), 5, & 7 with CV Accuracy:0.9330499 & Concordance: 0.8038155 with 150 Trees of Depth 1


## Type 1,2,3
```{r}
DT123.clean<-data.table(DT.clean[(Type=='1')|(Type=='2')|(Type=='3')])
setattr(DT123.clean$Type,"levels",c('1','2','3'))

ggplot(data = DT123.clean, aes(x=RI,fill=as.factor(Type)))+geom_density(alpha=0.25)
ggplot(data = DT123.clean, aes(x=Na,fill=as.factor(Type)))+geom_density(alpha=0.25)
ggplot(data = DT123.clean, aes(x=Mg,fill=as.factor(Type)))+geom_density(alpha=0.25) 
ggplot(data = DT123.clean, aes(x=Al,fill=as.factor(Type)))+geom_density(alpha=0.25) #Maybe 1 & 3
ggplot(data = DT123.clean, aes(x=Si,fill=as.factor(Type)))+geom_density(alpha=0.25)
ggplot(data = DT123.clean, aes(x=K,fill=as.factor(Type)))+geom_density(alpha=0.25)
ggplot(data = DT123.clean, aes(x=Ca,fill=as.factor(Type)))+geom_density(alpha=0.25)
ggplot(data = DT123.clean, aes(x=Ba,fill=as.factor(Type)))+geom_density(alpha=0.25) 
ggplot(data = DT123.clean, aes(x=Fe,fill=as.factor(Type)))+geom_density(alpha=0.25)

# define training control
train_controlA<- trainControl(method="LOOCV")
train_controlB<- trainControl(method="cv", number=(10))

# train the model 
set.seed(123)
gbm.fit123<- train(Type~.-Ba, data=DT123.clean, trControl=train_controlA, method="gbm")

gbm.fit123
plot(gbm.fit123)
summary(gbm.fit123)
confusionMatrix(predict(gbm.fit123,DT123.clean),DT123.clean$Type)

```
Use LOOCV since the in-class feature distributions have the similar means.